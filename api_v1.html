<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Irish Address Search</title>

    <!-- MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        .search-box {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 300px;
        }

        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-sizing: border-box;
        }

        .dropdown {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-top: none;
            background: white;
            display: none;
        }

        .dropdown-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body>
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Enter address" value="Setanta Place">
        <div id="dropdown" class="dropdown"></div>
    </div>

    <div id="map"></div>

    <script>
        // Initialize map
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://tiles.openfreemap.org/styles/liberty',
            center: [-8.0, 53.5],
            zoom: 6
        });

        let marker;
        let searchTimeout;

        // Search function with dropdown
        async function searchAddress(query) {
            const dropdown = document.getElementById('dropdown');

            if (query.length < 3) {
                dropdown.style.display = 'none';
                return;
            }
            console.log('query', query);
            try {
                const response = await fetch(`https://eircode.dataconversion.ie/api/eircodes/SearchAddress/?addressQuery=${encodeURIComponent(query)}&from=0&size=100&country=IRE`, {
                    "headers": {
                        "accept": "application/json, text/plain, */*",
                        "accept-language": "en,ru;q=0.9,uk;q=0.8",
                        "cache-control": "no-cache",
                        "pragma": "no-cache",
                        "sec-ch-ua": "\"Chromium\";v=\"140\", \"Not=A?Brand\";v=\"24\", \"Google Chrome\";v=\"140\"",
                        "sec-ch-ua-mobile": "?0",
                        "sec-ch-ua-platform": "\"Windows\"",
                        "sec-fetch-dest": "empty",
                        "sec-fetch-mode": "cors",
                        "sec-fetch-site": "same-site",
                        "x-api-key": "TestApiKey12345"
                    },
                    "referrer": "https://dataconversion.ie/",
                    "body": null,
                    "method": "GET",
                    "mode": "cors",
                    "credentials": "omit"
                });

                const data = await response.json();
                showDropdown(data.options || []);

            } catch (error) {
                console.error('Search error:', error);
                dropdown.style.display = 'none';
            }
        }

        // Show dropdown with results
        function showDropdown(options) {
            const dropdown = document.getElementById('dropdown');
            dropdown.innerHTML = '';

            if (options.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            options.forEach(option => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                // item.textContent = option.displayName;
                item.textContent = option.displayName;
                item.onclick = () => selectAddress(option);
                dropdown.appendChild(item);
            });

            dropdown.style.display = 'block';
        }

        // Handle address selection
        async function selectAddress(option) {
            const dropdown = document.getElementById('dropdown');
            const searchInput = document.getElementById('searchInput');

            searchInput.value = option.displayName;
            dropdown.style.display = 'none';

            // Get address details using the link
            if (option.link && option.link.href) {
                try {
                    const response = await fetch(option.link.href, {
                        "headers": {
                            "accept": "application/json, text/plain, */*",
                            "x-api-key": "TestApiKey12345"
                        },
                        "method": "GET",
                        "mode": "cors",
                        "credentials": "omit"
                    });

                    const data = await response.json();

                    if (data.addressDetails && data.addressDetails.latitude && data.addressDetails.longitude) {
                        showOnMap(data.addressDetails);
                    }

                } catch (error) {
                    console.error('Address detail error:', error);
                }
            }
        }

        // Show address on map
        function showOnMap(addressDetails) {
            const { latitude, longitude, eircode } = addressDetails;

            // Remove existing marker
            if (marker) marker.remove();

            // Add new marker
            marker = new maplibregl.Marker()
                .setLngLat([longitude, latitude])
                .addTo(map);

            // Add popup
            const addressText = [
                addressDetails.addressLine1,
                addressDetails.addressLine2,
                addressDetails.addressLine3,
                addressDetails.postTown,
                addressDetails.postCounty,
                eircode
            ].filter(line => line && line.trim()).join('<br>');

            const popup = new maplibregl.Popup({ offset: 25 })
                .setHTML(`<div style="font-size: 13px;">${addressText}</div>`);
            marker.setPopup(popup);

            // Fly to location
            map.flyTo({
                center: [longitude, latitude],
                zoom: 16
            });
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchAddress(e.target.value.trim());
            }, 300);
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-box')) {
                document.getElementById('dropdown').style.display = 'none';
            }
        });
    </script>
</body>

</html>